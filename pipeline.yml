pipeline {
    agent any

    stages {
        stage('Hello') {
            steps {
                echo 'Hello World'
            }
        }
        stage('Trigger CodeQL in GitHub Action') {
            steps {
                script {
                    withCredentials([string(credentialsId: '3777c30a-0948-46fe-9901-ed688e8ca8d6', variable: 'GITHUB_TOKEN')]) {
                        def response = httpRequest acceptType: 'APPLICATION_JSON',
                            consoleLogResponseBody: true,
                            customHeaders: [[name: 'Authorization', value: "Bearer ${GITHUB_TOKEN}"]],
                            url: 'https://api.github.com/repos/claireelyse/jenkins/actions/workflows/codeql-analysis.yml/dispatches',
                            validResponseCodes: '204',
                            requestBody: '{"ref":"main"}'
                        
                        if (response.status != 204) {
                            error "Failed to trigger GitHub Action"
                        } else {
                            echo "GitHub Action triggered successfully."
                        }
                    }
                }
            }
        }
    }
}
